-- Runs inside the container at first startup as SYSTEM
-- Goal: Use a single common user C##CDC for both IntelliJ (PDB) and Debezium (CDB/PDB)

-- 1) Create common user at CDB root and enable minimal supplemental logging
ALTER SESSION SET CONTAINER = CDB$ROOT;

-- Configure Fast Recovery Area (FRA) and archive destination, then enable ARCHIVELOG & FORCE LOGGING
BEGIN
  EXECUTE IMMEDIATE 'ALTER SYSTEM SET db_recovery_file_dest = ''/opt/oracle/oradata/recovery_area'' SCOPE=BOTH';
  EXECUTE IMMEDIATE 'ALTER SYSTEM SET db_recovery_file_dest_size = 10G SCOPE=BOTH';
  EXECUTE IMMEDIATE 'ALTER SYSTEM SET log_archive_dest_1 = ''LOCATION=USE_DB_RECOVERY_FILE_DEST'' SCOPE=BOTH';
EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- Switch database into ARCHIVELOG mode (required by Debezium)
SHUTDOWN IMMEDIATE;
STARTUP MOUNT;
ALTER DATABASE ARCHIVELOG;
ALTER DATABASE OPEN;
ALTER DATABASE FORCE LOGGING;

  -- Create common user across all containers (ignore if exists)
  DECLARE v_cnt NUMBER;
  BEGIN
    SELECT COUNT(*) INTO v_cnt FROM cdb_users WHERE username = 'C##CDC';
  IF v_cnt = 0 THEN
    EXECUTE IMMEDIATE 'CREATE USER C##CDC IDENTIFIED BY cdcpass CONTAINER=ALL';
  END IF;
  END;
  /

-- Grants required by Debezium Oracle connector
BEGIN
  EXECUTE IMMEDIATE 'GRANT CREATE SESSION TO C##CDC CONTAINER=ALL';
  EXECUTE IMMEDIATE 'GRANT LOGMINING TO C##CDC CONTAINER=ALL';
  EXECUTE IMMEDIATE 'GRANT SELECT ANY TRANSACTION TO C##CDC CONTAINER=ALL';
  EXECUTE IMMEDIATE 'GRANT EXECUTE_CATALOG_ROLE TO C##CDC CONTAINER=ALL';
  EXECUTE IMMEDIATE 'GRANT SELECT ANY DICTIONARY TO C##CDC CONTAINER=ALL';
  EXECUTE IMMEDIATE 'GRANT SET CONTAINER TO C##CDC CONTAINER=ALL';
  EXECUTE IMMEDIATE 'ALTER USER C##CDC IDENTIFIED BY cdcpass';
  EXECUTE IMMEDIATE 'ALTER USER C##CDC ACCOUNT UNLOCK';
END;
/

-- Debezium requires minimal supplemental logging at the CDB level
BEGIN
  EXECUTE IMMEDIATE 'ALTER DATABASE ADD SUPPLEMENTAL LOG DATA';
EXCEPTION WHEN OTHERS THEN NULL; END;
  /
  

-- 2) Switch to PDB XEPDB1 and prepare schema/objects
ALTER SESSION SET CONTAINER = XEPDB1;

BEGIN
  EXECUTE IMMEDIATE 'ALTER USER C##CDC QUOTA UNLIMITED ON USERS';
  EXECUTE IMMEDIATE 'GRANT CREATE SESSION TO C##CDC';
  EXECUTE IMMEDIATE 'GRANT RESOURCE TO C##CDC';
  EXECUTE IMMEDIATE 'GRANT CREATE TABLE TO C##CDC';
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE C##CDC.CUSTOMERS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    first_name VARCHAR2(50),
    last_name VARCHAR2(50),
    email VARCHAR2(120),
    updated_at TIMESTAMP DEFAULT SYSTIMESTAMP
  )';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -00955 THEN RAISE; END IF; -- ignore already exists
END;
/

-- Enable all column supplemental logging for captured table
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE C##CDC.CUSTOMERS ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

INSERT INTO C##CDC.CUSTOMERS (first_name, last_name, email) VALUES ('Jane','Doe','jane.doe@example.com');
COMMIT;

-- Simple demo tables with auto id and name
BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE C##CDC.PROJECTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(200)
  )';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -00955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE C##CDC.EMPLOYEES (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(200)
  )';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -00955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE C##CDC.DEPARTMENTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(200)
  )';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -00955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE C##CDC.PRODUCTS (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(200)
  )';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -00955 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'CREATE TABLE C##CDC.ORDERS_SIMPLE (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(200)
  )';
EXCEPTION WHEN OTHERS THEN
  IF SQLCODE != -00955 THEN RAISE; END IF;
END;
/

-- Enable supplemental logging for new demo tables
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE C##CDC.PROJECTS ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE C##CDC.EMPLOYEES ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE C##CDC.DEPARTMENTS ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE C##CDC.PRODUCTS ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE C##CDC.ORDERS_SIMPLE ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

-- Final restart to ensure all logging settings are active before use
ALTER SESSION SET CONTAINER = CDB$ROOT;
SHUTDOWN IMMEDIATE;
STARTUP;
